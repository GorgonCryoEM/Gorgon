# Copyright (C) 2005-2008 Washington University in St Louis, Baylor College of Medicine.  All rights reserved
# Author:        Sasakthi S. Abeysinghe (sasakthi@gmail.com)
# Description:   A widget that manages all the windows of the main form. 

# CVS Meta Information: 
#   $Source: /project/mm/cvs/graphics/ssa1/source/Gorgon/src_py/window_manager.py,v $
#   $Revision: 1.14 $
#   $Date: 2009/12/27 00:31:04 $
#   $Author: ssa1 $
#   $State: Exp $
#
# History Log: 
#   $Log: window_manager.py,v $
#   Revision 1.14  2009/12/27 00:31:04  ssa1
#   Fixing weird PyOpenGL bug when working with new PyQT4, and parent window set.
#
#   Revision 1.13  2009/12/24 05:09:30  ssa1
#   Refactoring child window behavior.. Using base classes to encapsulate common behavior
#
#   Revision 1.12  2009/10/05 17:57:37  ssa1
#   Initial session saving functionality (Request ID:52)
#
#   Revision 1.11  2009/04/08 19:54:59  ssa1
#   Adding in plugin functionality
#
#   Revision 1.10  2008/12/18 15:19:31  ssa1
#   Moving About Form functionality into HelpMenus
#
#   Revision 1.9  2008/06/18 18:15:41  ssa1
#   Adding in CVS meta data
#

from PyQt4 import QtGui, QtCore
from help_menus import HelpMenus
from camera import Camera
from volume_viewer import VolumeViewer
from skeleton_viewer import SkeletonViewer
from sse_viewer import SSEViewer
from calpha_viewer import CAlphaViewer
import datetime
from session_manager import SessionManager

class WindowManager(QtGui.QWidget):
    
    def __init__(self, main, parent=None):
        QtGui.QWidget.__init__(self, parent)
        self.app = main
        self.createUI()

    def createUI(self):
        self.createActions()
        self.createMenus()
        self.createChildWindows()        
        
    def createChildWindows(self):
        self.helpMenus = HelpMenus(self.app)
        self.volumeViewer = VolumeViewer(self.app)
        self.skeletonViewer = SkeletonViewer(self.app)
        self.sseViewer = SSEViewer(self.app)
        self.calphaViewer = CAlphaViewer(self.app)
        self.mainCamera = Camera([self.calphaViewer, self.sseViewer, self.skeletonViewer, self.volumeViewer], self.app)
        self.app.mainCamera = self.mainCamera   
        self.app.setCentralWidget(self.mainCamera)
        
    def createActions(self):
        self.saveSessionAct = QtGui.QAction(self.tr("Sessio&n..."), self)
        self.saveSessionAct.setStatusTip(self.tr("Save the current session"))
        self.connect(self.saveSessionAct, QtCore.SIGNAL("triggered()"), self.saveSession)
        self.app.actions.addAction("save_Session", self.saveSessionAct)  
        
        self.loadSessionAct = QtGui.QAction(self.tr("Sessio&n..."), self)
        self.loadSessionAct.setStatusTip(self.tr("Load a session from file"))
        self.connect(self.loadSessionAct, QtCore.SIGNAL("triggered()"), self.loadSession)
        self.app.actions.addAction("load_Session", self.loadSessionAct)          

        self.closeSessionAct = QtGui.QAction(self.tr("Sessio&n..."), self)
        self.closeSessionAct.setStatusTip(self.tr("Close session"))
        self.connect(self.closeSessionAct, QtCore.SIGNAL("triggered()"), self.closeSession)
        self.app.actions.addAction("close_Session", self.closeSessionAct)          
            
    def createMenus(self):
        self.app.menus.addAction("file-save-session", self.app.actions.getAction("save_Session"), "file-save")
        self.app.menus.getMenu("file-save").addSeparator()
        self.app.menus.addAction("file-open-session", self.app.actions.getAction("load_Session"), "file-open")
        self.app.menus.getMenu("file-open").addSeparator()
        self.app.menus.addAction("file-close-session", self.app.actions.getAction("close_Session"), "file-close")
        self.app.menus.getMenu("file-close").addSeparator()

        
    def getSessionHeader(self, sessionManager):           
        header = []
        header.extend(sessionManager.getRemarkLines("APP", "DESC", "Session Information"))
        header.extend(sessionManager.getRemarkLines("APP", "SAVED_ON",  datetime.datetime.now()))
        header.extend(sessionManager.getRemarkLines("APP", "VERSION", self.app.version))               
        return header       
                       
    def saveSessionToFile(self, fileName):
        sessionManager = SessionManager(self.app)
        file = open(fileName, "w")
        textLines = []
        textLines.extend(self.getSessionHeader(sessionManager))
        textLines.extend(self.mainCamera.getSessionInfo(sessionManager))
        textLines.extend(self.volumeViewer.getSessionInfo(sessionManager))
        textLines.extend(self.skeletonViewer.getSessionInfo(sessionManager))
        textLines.extend(self.sseViewer.getSessionInfo(sessionManager))
        textLines.extend(self.calphaViewer.getSessionInfo(sessionManager))
        
        file.writelines(textLines)
        file.close()
                
        
    def saveSession(self):
        fileName = QtGui.QFileDialog.getSaveFileName(self, self.tr("Save Session"), "", self.tr("Gorgon Session File (*.pdb)"))
        if not fileName.isEmpty():  
            self.setCursor(QtCore.Qt.WaitCursor)
            self.saveSessionToFile(fileName)
            self.setCursor(QtCore.Qt.ArrowCursor)        
    
    def loadSessionFromFile(self, fileName):
        sessionManager = SessionManager(self.app)
        file = open(fileName, "r")
        propertyDict = sessionManager.parseTextLines(file.readlines())
        
        self.volumeViewer.loadSessionInfo(sessionManager, propertyDict)
        self.skeletonViewer.loadSessionInfo(sessionManager, propertyDict)
        self.sseViewer.loadSessionInfo(sessionManager, propertyDict)
        self.calphaViewer.loadSessionInfo(sessionManager, propertyDict)
               
        self.mainCamera.loadSessionInfo(sessionManager, propertyDict)
        file.close()
        
            
    def loadSession(self):
        fileName = QtGui.QFileDialog.getOpenFileName(self, self.tr("Load Session"), "", self.tr("Gorgon Session File (*.pdb)"))
        if not fileName.isEmpty():  
            self.setCursor(QtCore.Qt.WaitCursor)
            self.loadSessionFromFile(fileName)
            self.setCursor(QtCore.Qt.ArrowCursor)               

    def closeSession(self):
        if (QtGui.QMessageBox.warning(self, self.tr("Are you sure?"), self.tr("You are about to close the session.  All unsaved data will be lost!"), QtGui.QMessageBox.Yes, QtGui.QMessageBox.Cancel) == QtGui.QMessageBox.Yes):
            if (self.volumeViewer.loaded) :
                self.volumeViewer.unloadData()
            if (self.skeletonViewer.loaded) :
                self.skeletonViewer.unloadData()
            if (self.sseViewer.loaded) :
                self.sseViewer.unloadData()
            if (self.calphaViewer.loaded) :
                self.calphaViewer.unloadData()